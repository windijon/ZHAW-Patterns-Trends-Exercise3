---
title: "Aufgabe_3"
author: "windijon"
date: '2022-05-06'
output: html_document
---


### Task 1: Segmentation

Load the necessary libraries.

```{r}

library(readr)        # to import tabular data (e.g. csv)
library(dplyr)        # to manipulate (tabular) data
library(ggplot2)      # to visualize data
library(sf)           # to handle spatial vector data
library(terra)        # To handle raster data
library(lubridate)    # To handle dates and times
library(zoo)          # to handle Rolling window functions

```

Import the wild-boar data "caro60" as csv.

```{r}

caro <- read_delim("caro60.csv",",")
View(caro)

```

Create a temporal window of 6 minutes and calculating the Euclidean Distances (step-length).

```{r}

caro <- caro %>% 
  mutate(
    nMinus3 = sqrt((lag(E,3)-E)^2 + (lag(N,3)-N)^2),
    nMinus2 = sqrt((lag(E,2)-E)^2 + (lag(N,2)-N)^2),  
    nMinus1 = sqrt((lag(E,1)-E)^2 + (lag(N,1)-N)^2),
    nPlus1  = sqrt((E-lead(E,1))^2 + (N-lead(N,1))^2), 
    nPlus2  = sqrt((E-lead(E,2))^2 + (N-lead(N,2))^2),  
    nPlus3  = sqrt((E-lead(E,3))^2 + (N-lead(N,3))^2)  
)
View(caro)

caro <- caro %>% 
  rowwise() %>% 
  mutate(stepMean = mean(c(nMinus3, nMinus2, nMinus1, nPlus1, nPlus2, nPlus3))) %>% 
  ungroup()
View(caro)

```


### Task 2: Specify and apply threshold

Explore the step-lengths and specify the threshold.

```{r}

histogram <- ggplot(data = caro, aes(x = stepMean)) +
  geom_histogram(bins = 200) +
  labs(y = "Count", x = "Step-Length [m]") +
  ggtitle("Histogram of the Step-Length of the Wild-Boar 'Caro' at 15.09.2015") +
  theme_minimal()
histogram

boxplot <- ggplot(data = caro, aes(x = stepMean, y = TierName)) +
  geom_boxplot() +
  labs(y = "", x = "Step-Length [m]") +
  ggtitle("Boxplot of the Step-Length of the Wild-Boar 'Caro' at 15.09.2015") +
  theme_minimal()
boxplot

ggsave(plot = histogram, filename = "Histogram_StepLength.pdf", width = 17, height = 14, units = "cm", dpi = 5000)
ggsave(plot = boxplot, filename = "Boxplot_StepLength.pdf", width = 17, height = 14, units = "cm", dpi = 5000)

summary(object = caro$stepMean)
mean(caro$stepMean, na.rm = T)

```

Apply the threshold.

```{r}

caro <- caro %>%
  ungroup() %>% 
  mutate(static = stepMean <= mean(x = caro$stepMean, na.rm = T))
View(caro)

```


### Task 3: Visualize segmented trajectories

Visualize the segmented trajectory spatially.

```{r}

plot_static_movement <- ggplot(data = caro, aes(x = E, y = N, color = static)) +
  geom_path(color = "grey") +
  geom_point() +
  labs(y = "East", x = "North", colour = "Static Movement") +
  ggtitle("Movement of the Wild-Boar 'Caro' at 15.09.2015") +
  coord_fixed() +
  theme_minimal()
plot_static_movement

ggsave(plot = plot_static_movement, filename = "Static_Movement.pdf", width = 17, height = 14, units = "cm", dpi = 5000)

```


### Task 4: Segment-based analysis

Function to create unique ID for each segment.

```{r}

rle_id <- function(vec){
  x <- rle(vec)$lengths
  as.factor(rep(seq_along(x), times=x))
  }

```

Assign unique IDs based on the column "static".

```{r}

caro <- caro %>%
  mutate(segment_id = rle_id(static))
View(caro)

```

Visualize the moving segments (all segments).

```{r}

caro_filter_1 <- caro %>%
  filter(!static)
View(caro_filter_1)

plot_moving_segments_all <- ggplot(data = caro_filter_1, aes(x = E, y = N, color = segment_id)) +
  geom_path(color = "grey") +
  geom_point() +
  labs(y = "East", x = "North", colour = "Segment ID") +
  ggtitle("Moving Segments of the Wild-Boar 'Caro' at 15.09.2015 (All Segments)") +
  coord_fixed() +
  theme_minimal()
plot_moving_segments_all

ggsave(plot = plot_moving_segments_all, filename = "Moving_Segments_all.pdf", width = 17, height = 14, units = "cm", dpi = 5000)

```

Visualize the moving segments (only long segments, < 5 minutes).

```{r}

caro_filter_2 <- caro %>% 
  filter(!static) %>% 
  group_by(segment_id) %>% 
  mutate(duration = as.integer(difftime(max(DatetimeUTC),min(DatetimeUTC), units = "mins"))) %>%
  filter(duration > 5)
View(caro_filter_2)

plot_moving_segments_long <- ggplot(data = caro_filter_2, aes(x = E, y = N, color = segment_id)) +
  geom_path(color = "grey") +
  geom_point() +
  labs(y = "East", x = "North", colour = "Segment ID") +
  ggtitle("Moving Segments of the Wild-Boar 'Caro' at 15.09.2015 (Long Segments)") +
  coord_fixed() +
  theme_minimal()
plot_moving_segments_long

ggsave(plot = plot_moving_segments_long, filename = "Moving_Segments_long.pdf", width = 17, height = 14, units = "cm", dpi = 5000)

```

